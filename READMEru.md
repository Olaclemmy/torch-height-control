# Регулятор высоты плазменной горелки
Регулятор высоты плазменной горелки на базе Arduino (МК ATmega328P). Применим для улучшения качества реза неровных листов и заготовок металла методом плазменной резки. Регулятор полностью перехватывает на себя управление вертикальной осью от станка ЧПУ (т.е. включается "в разрыв"). На случай необходимости предусмотрен режим работы "в обход", при котором контроль высоты не активен. Текущая высоты горелки во время реза определяется из напряжении плазменной дуги: чем выше напряжение, тем больше высота, и наоборот.

### Функциональность
  - Прием сигналов от ЧПУ для начального позиционирования горелки по высоте, а также для ручного подъема/опускания;
  - Привод оси Z - шаговый мотор (биполярное 4-х проводное включение);
  - Автоматическое определение напряжения (высоты) удержания при заданной высоте прокола;
  - Регулируемый интервал нечувствительности регулятора (петля гистерезиса);
  - Аппаратная и программная фильтрация шумов;
  - Отображение текущего напряжения дуги (позволяет оценить процесс регулировки);
  - Детектирование касания металла (не требуется предварительно выставлять начальную высоту);
  - Режим работы "в обход", при котором система воспринимает только сигналы вверх/вниз;
  - Подробное меню для настройки необходимых параметров;
  - Параметры сохраняются после выключения устройства.

### Алгоритм работы
  - После отправки станком ЧПУ сигнала на включение плазмы горелка опускается до касания с листом металла;
  - После касания горелка приподнимается на высоту прокола (параметр задается);
  - Горелка удерживается в данной позиции на время прокола (параметр задается);
  - Запускается регулировка по уровню напряжения. Начинается процесс непосредственного вырезания детали;
  - После подачи станком ЧПУ сигнала на отключение плазмы регулятор переходит в изначальное состояние (ждущий режим).

### Подключение
Регулятор включается в разрыв текущей цепи управления осью вертикального отклонения и перехватывает на себя все соответствующие сигналы.
Входы регулятора (в скобках указаны выводы ATmega328P и Arduino по умолчанию):
  - **UP** (PB2, 10) - сигнал подъема горелки. Подъем осуществляется все время, пока подается данный сигнал;
  - **DOWN** (PB3, 11) - сигнал опускания горелки. Опускание осуществляется все время, пока подается данный сигнал;
  - **PLASM** (PB4, 12) - сигнал включения плазмы. Сигнал должен поступать как в регулятор, так и непосредственно запускать плазму в горелке (можно использовать, например, реле с двумя группами контактов);
  - **TOUCH** (PB1, 9) - сигнал касания горелкой листа металла. Возможно несколько вариантов, в зависимости от конструкции горелки и оси Z. В частности, возможна установка емкостного датчика, либо подключение к соплу горелки;
  - **FEEDBACK** (PC1, A1) - аналоговый сигнал напряжения дуги, снятый с резистивного делителя напряжения. Номиналы плечей делителя подбираются исходя из диапазона рабочих напряжений плазмотрона и с учетом запаса. Напряжение на данном входе должно всегда быть в пределах [0; 5] Вольт. Резкие скачки и перепады, а также шумы в сигнале следует устранить установкой фильтра;
  - **SETTINGS ADC** (PC0, A0) - аналоговый вход ручки настройки параметров. Обычно - потенциометр сопротивлением 3-100 кОм и размахом напряжений 0-5 В;
  - **SETTINGS BUTTON** (PB0, 8) - кнопка циклического выбора меню.

Все цифровые входы по умолчанию - типа "активный ноль", и должны быть подтянуты к питанию (+5В DC - питание Arduino). Во избежание влияния наводок и помех необходимо осуществить качественный монтаж и не располагать устройство вблизи высоковольтных или силовых частей. При необходимости сделайте экранировку. Для безопасности компонентов также рекомендуется развязать все связи с остальными частями станка и использовать отдельный гальванически развязанный источник питания.

Выходы:
  - **MOTOR_PHASE_A**, **MOTOR_PHASE_B**, **MOTOR_PHASE_C**, **MOTOR_PHASE_D** - четыре вывода (фазы) шагового двигателя (A, B, C, D). Подключение через любые ключи: дискретные полевые/биполярные транзисторы, сборки, драйверы и т.д. Правильный порядок включения фаз: A-C-B-D. По умолчанию настроены выводы PC2-PC5 (A2-A5):
    - PC2 (A2) - A;
    - PC3 (A3) - C;
    - PC4 (A4) - B;
    - PC5 (A5) - D.

Дисплей:
По умолчанию двухстрочный ЖК-дисплей типа HD44780 подключается к выводам порта D с PD1 по PD7 (Arduino 1-7):
  - PD4 (4) - DB4;
  - PD5 (5) - DB5;
  - PD6 (6) - DB6;
  - PD7 (7) - PD7;
  - PD1 (1) - RS;
  - PD2 (2) - RW
  - PD3 (3) - E.

### Настройка параметров программы (опционально)
Перед прошивкой микроконтроллера (МК) можно изменить некоторые параметры в основном файле программы ```main.c``` и заголовочных файлах соответствующих библиотек:
  - Порты ввода-вывода (если было выбрано отличное от рекомендуемого подключение);
  - Интервал настройки петли гистерезиса регулировки (```GOALOFFSET_MIN_SET_VOLTAGE``` и ```GOALOFFSET_MAX_SET_VOLTAGE```);
  - Значение по умолчанию петли гистерезиса регулировки (```Goal_offset_EEPROM```);
  - Значение по умолчанию высоты прокола (```lift_before_cut_EEPROM```);
  - Значение по умолчанию времени прокола (```delay_before_regulation_EEPROM```);
  - Режим "в обход" (```bypass_ON_flag_EEPROM```): ВКЛ (```1```) или ВЫКЛ (```0```);
  - Число значений для определения напряжения дуги, которое будет удерживать регулятор (```NUM_OF_VALUES_FOR_GOAL_DEFINITION```). Слишком маленькое значение не позволит точно определить нужное напряжение, а слишком большое будет занимать много времени (особенно при высокой зашумленности и неоднородности сигнала);
  - Число значений для усреднения при программном усреднении напряжения дуги (```PRESCALER_CNT_COMPARE_VALUE```). Это значение также влияет на частоту алгоритма контроля и, следовательно, на скорость реакции системы: чем больше значений усредняется, тем ниже частота отклика;
  - Интервал нечувствительности при программном усреднении напряжения дуги (```OFFSET_FOR_AVRG```).

### Сборка программы и прошивка
Для сборки рекомендуется использовать программу PlatformIO:
  - Импортируйте папку репозитория: ```File``` -> ```Add Project Folder```;
  - При необходимости настройте параметры прошивки в файле ```platformio.ini``` (например, укажите, использовать для прошивки программатор или нет);
  - Запустите сборку ```PlatformIO``` -> ```Build```;
  - Откройте встроенный терминал и выполните команду (при загрузке через программатор):
    ```sh
    $ pio run -t program; pio run -t uploadeep
    ```
    При загрузке через плату Arduino:
    ```sh
    $ pio run -t upload; pio run -t uploadeep
    ```

### Использование
После прошивки регулятора на дисплее отображается главное меню (ждущий режим). На нем отображаются текущие настройки интервала гистерезиса при регулировании, высоты (```lft```) и задержки (```dlay```) прокола. Нажатием кнопки меню перейдите к настройкам и задайте параметр с помощью потенциометра. В скобках указано текущее значение параметра. Нажимайте кнопку меню, пока не настроите все параметры и не вернетесь в главное меню.
После замыкания реле плазмы отображается надпись ```start...```. После касания горелкой листа металла надпись сменяется на ```pierce...``` и сохраняется все время прокола. Затем промаргивает надпись ```define goal```, во время которой система определяет напряжение дуги для удержания, и, наконец, дисплей переходит в рабочий режим: верхняя строчка отображает измеренное напряжение удержания, нижняя - текущее напряжение (усредненное). Если надпись ```define goal``` сохраняется слишком долго, то это говорит о слишком большом количестве точек для определения уставки (```NUM_OF_VALUES_FOR_GOAL_DEFINITION```), либо слишком маленьком интервале усреднения (```OFFSET_FOR_AVRG```), либо сильно зашумленном сигнале.
По возвращении в режим ожидания (после размыкания реле плазмы) в первой строчке будет отображаться последнее измеренное значение напряжения дуги.
Для входа в режим "обхода" удерживайте нажатой кнопку меню около 8 секунд. На экране отобразится надпись ```regulation off```. Регулятор будет реагировать только на сигналы подъема/опускания. Текущий режим сохраняется при сбросе и отключении питания. Для выхода из режима также удерживайте кнопку меню в течение 8 секунд.

## Другое
Поведение контроллера при подаче нескольких управляющих сигналов одновременно (например, сигнал зажигания плазмы и касания) в общем случае не определено и зависит от порядка их обработчиков в коде прерывания `PCINT0_vect`. Благодаря конструкции `if - else if` исключается выполенение нескольких блоков за один проход прерывания, однако все же данные ситуации крайне не рекомендуются. Впрочем, при работе в реальном устройстве подобные случаи не должны встречаться.
